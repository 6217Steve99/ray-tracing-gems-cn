## 8.2 GARP细节
光线和面片的交点由$t$（对于沿光线的交点）和$\{u,v\}$（对于面片上的交点）定义。仅仅知道$t$是不够的，因为还需要$\{u,v\}$来计算法线。虽然我们最终会需要全部三个变量，我们从简单的几何考虑先计算$t$的值（不通过求解代数方程）。

双线性面片的边（等式1）都是直线，我们首先在相对的边上定义两个点$P_{a}(u) = (1-u)Q_{00}  + u Q_{10}$和$P_{b}u(u) = (1-u)Q_{01} + uQ_{11}$。通过这些点，我们考虑一系列经过$P_{a}$和$P_{b}$的线段。对于任何$u \in [0,1]$，线段$(P_{a}(u), P_{b}(u))$一定在面片上。

第一步，我们首先推到出计算光线和线段$(P_{a}(u), P_{b}(u))$间的有正负的距离的方程，并将方程的值设置为0。距离方程为$(P_{a} - 0) \cdot \textbf{n} / \| \textbf{n} \|$，其中$\textbf{n} = (P_{a} - P_{b}) \times \hat{\textbf{d}}$。我们仅需要分子部分，将其设为0就可以得到关于$u$的二次方程。

分子部分是标量乘积$(P_{a} - 0) \dot (P_{b} - P_{a}) \times \hat{\textbf{d}}$，也是是由三个向量定义的平行六面体的（有正负的）体积。是关于$u$的二次多项式。通过一些简单的简化之后，多项式的系数简化到在8.4节中14-17行中计算的三个系数$a,b,c$。我们将$\textbf{q}_{n} = (Q_{10} - Q_{00}) \times (Q_{01} - Q_{11})$单独预先计算。如果该向量的长度为0，那么四边形就可以简化为平面梯形，$u^{2}$的系数$c$为0。我们在代码中使用显示分支来处理这种情况(8.4节中的第23行)。

对于非梯形的一般平面四边形，向量$\textbf{q}_{n}$和四边形平面垂直。显示计算和使用$\textbf{q}_{n}$的值有助于计算的准确性，因为在大多数模型中，面片几乎是平面的。很关键的是即使是对于平面面片，方程$a + bu + c u^{2}$也有两个解。图8-5的左图显示了这样一种情况。方程的两个解都落在$[0,1]$的区间内，我们需要计算$v$来舍掉其中一个解。这张图显示了一个自我重叠的面片。对于不重叠的平面四边形，只会有一个$u$和$v$都在$[0,1]$区间内的解。即便如此，也没有必要在代码中明确表达这种逻辑，因为这会增加没有必要的代码差异。

使用经典公式$\frac{-b \pm \sqrt{b^{2} - 4ac}}{2c}$有其危险性，根据$b$的符号不同，其中一个根需要计算两个（相对）大数的差。出于这个原因，我们先计算稳定解[23]，然后使用Vieta公式$u_{1}u_{2} = a/c$来计算第二个解（代码26行）。

第二步，我们对于每个$u \in [0,1]$的解，计算对应的$v$的值。最简单的方法是从$P_{a} + v(P_{b} - P_{a}) = O + t \hat{\textbf{d}}$的三个等式中任选两个。但是因为$P_{a}(u)$和$P_{b}(u)$的坐标不是精确计算的，并且并不能明显的选择最好的两个方程,可能会导致数值误差。

我们测试了不同方法。神奇的是，最好的方法是忽略$O + t \hat{\textbf{d}}$和$P_{a} + v(P_{b} - P_{a})$相交的事实。我们计算让这两条线距离最短的$v$和$t$（最短距离非常接近0）。通过计算和两条线都垂直的$\textbf{n} = (P_{b} - P_{a}) \times \hat{\textbf{d}}$来简化计算。对应的代码在8.4节中的31行和43行之后，包括了一些线性代数简化。

通常来讲，一条射线和一个平面，如果两者不平行，那么肯定存在交点。但是对于非平面双线性曲面来说，并不一定存在交点，如图8-5的右图所示。因此，我们对于行列式是负的部分，不进行相交测试。

把以上部分整合在一起写成简单干净的代码。代码可以通过把面片转换到光线为中心的空间: $O = 0, \hat{\textbf{d}} = \{0,0,1\}$来进一步简化。Duff等人[8]最近提出了类似的无分支转换算法。然而我们发现这种方法只能轻微的提升效率，因为GARP是已经优化到了下一阶段的算法。
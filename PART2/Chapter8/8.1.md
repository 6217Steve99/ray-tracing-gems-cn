## 8.1 简介与当前技术 

计算机图形学力求以其丰富的形状和颜色渲染现实世界。通常使用曲面细分以充分利用现代GPU的性能。当前两种主要的渲染模式：光栅化与光线追踪，都支持硬件优化的三角形图元。但是曲面细分的缺点在于需要大量内存占用来精确表达复杂形状。 

内容制作工具处于对简单性和表现力的需求而倾向于使用更高阶的曲面。这些曲面可以直接在DirectX 11硬件管线中进行细分与光栅化[7,11]。至今为止，现代GPU并不支持非平面图元的光线追踪。

我们重新审视对于高阶图元的光线追踪，试图在三角形的简单性与诸如细分曲面[3,16],NURBS[1]和Bézier曲面[2]等平滑形状之间找到平衡点。

通常，我们用三阶（或更高阶）的表达式来生成法线连续的平滑曲面。Peter[21]提出了一个通过二次和三次面片共同建模光滑曲面的方法。对于高度场，可以通过将每个三角形细分为24个小三角形来实现对任意三角形mesh的$C^{1}$二次插值。插值给定定点的位置与导数需要更多的控制点。如图8-1所示，对于一个仅有二次或分段线性面片组成的曲面，通过插值顶点法线，可以使用Phong着色法[22]实现光滑曲面的渲染。对于此模型，我们在接下来的部分中将要提到相交计算算法相较于Optix系统[20]中的优化后的光线/三角形相交计算算法快7%。

Vlachos等人[26]引入了一种曲面点-法线(PN)三角形，它只使用三个顶点和三个顶点的法线来创建三次Bézier 面片. 对于这种曲面，通过二次插值渲染法线以模拟光滑光照。我们可以通过局部插值来将PN三角形转化成$G^{1}$连续曲面。

Boubekeur和Alexa[6]也试图使用完全的局部表达法，并提出了Phong曲面细分的方法。他们论文的基本思想是将几何体充分膨胀以避免出现刻面。

以上这些技术，使用参数域中的采样，都非常适合光栅化。如果选择光线追踪，计算光线与这些曲面的交点需要求解非线性方程。非线性方程通常需要通过迭代来求解[2,13].

三角形由其三个顶点定义。或许最简单的通过插值四个给定点$Q_{ij}$形成的，并且可以计算单步光线相交的曲面面片是双线性面片，表达式为:
$$
    Q(u,v) = (1-u)(1-v)Q_{00} + (1-u)vQ_{01} + u(1-v)Q_{10} + uvQ_{11}
$$

这样的双变量曲面在$\{u,v\} = \{i,j\}$时经过四个角点。如图8-4和图8-5所示，该曲面是由$u=const$和$v=const$形成的双重直纹曲面。当四个角点处于同一平面时，可以通过将四边形分成两个三角形来找到一个相交点。Lagae和Dutré[15]提出了更有效的算法。

对于非平面曲面，可能与光线$R(t) = o + t \hat{d}$有两个相交点。光线由起点$O$和单位方向$\hat{d}$定义。当前最好的算法由Ramsey等人[24]提出，该算法通过代数方法求解三个二次方程$R(t) = Q(u,v)$的系统。

在迭代方法中，可以通过增加迭代次数减少误差。在直接方法中，并没有对应的保证，二次方程可能会导致无边界的误差。讽刺的是，对于更平整的面片来说，出现重大误差的可能性会更大，尤其是当面片距离较远时。为了解决这个问题，Ramsey等人使用的是双精度浮点数(double)。我们将他们的算法以单精度浮点数(float)实现后发现在某些角度会产生明显误差，如图8-2所示。

找到光线和三角形的交点是一个相对简单的问题。该问题可以通过考虑基本几何结构(光线/平面交点，线之间的距离，三角形的面积，四面体体积等）简化。我们通过利用直纹曲面的特性(等式1)，将相似方法应用于光线/面片的相交问题。
虽然Hanrahan[11]提出了相似的方法，但该方法仅适用于平面情况。


## 8.1.1 性能测试
为了便于记忆，我们将我们的技术命名为GARP(Geometric Approach to Ray/bilinear 面片 intersection的缩写)。这项技术相较于Ramsey等人[24]的使用单精度浮点数算法性能提升了大约两倍。由于光线追踪速度受到加速结构遍历和渲染的显著影响，真实的GARP算法的性能甚至高于此。

为了更好理解这些问题，我们创建了一个单面片模型并执行了多个相交测试，以消除遍历和渲染对于性能的影响。实验结果表明，GARP算法相较于Ramsey的单精度算法要快6.5倍。

实际上，GARP比在渲染时用两个三角形近似四边形的算法更快（它会导致渲染结果稍有不同）。我们还测量了在预处理阶段将四边形分成三角形然后构建BVH(Bounding Volume Hierarchy)的算法的性能。有趣的是，这种方法比其他两种版本要慢，GARP和实时三角形近似算法速度相似。我们根据Walter等人[27]的文章推测通过四边形表示几何体，相较于曲面细分的模型，可以起到更有效的凝聚聚类的作用。

参数化表达曲面的一个优点是曲面是从二维参数空间$\{u,v\} \in [0,1] \times [0,1]$到三维形状的映射。使用光栅化渲染的程序可以直接在二维参数域内采样。在光线追踪算法中，一旦找到相交点，可以判断相交点的$u$和$v$是否在$[0,1]$范围内来仅保留有效的相交点。

如果使用隐式曲面$f(x,y,z) = 0$作为渲染图元，则必须裁剪拼合不同面片来形成复合曲面。对于边缘式线段的双线性面片，这种裁剪相当简单。Stroll等人[25]提出了一种将双线性面片转换为二次隐式曲面的方法。我们并没有直接将该方法与GARP相比较，但是注意他们的方法需要将四个相交点通过四面体$\{Q_{00}, Q_{01}, Q_{10}, Q_{11}\}$的正面三角形来裁剪。GARP的性能比仅使用两个光线/三角形相交的算法更快。我们通过考虑双线性面片的特殊性质（其为规则曲面）来达到这个性能。另一方面，隐式二次曲线在自然中更为常见，并且可以表达圆柱体和球体。

## 8.1.2 网格四边形化
一个很重要的问题在于如何将一个三角形mesh转换为用四边形表示。我们测试了三个系统：

1. Blender
2. Instant field-aligned meshes方法，Jakob等人[12]
3. 通过Morse-参数化混合系统的四边形化方法，Fang等人[9]

只有最后一个系统可以创建完全四边形化的网格。有两种处理三角形/四边形混合网格的方法：将每个三角形视为退化四边形，或者对于三角形使用光线/三角形相交算法。我们选择使用前一种方法，因为它由于减少了额外的分支，稍快一些。将$Q_{11} = Q_{10}$带入等式1中，我们可以将面片的参数$\{u,v\}$变换为$\{(1-u)(1-v), u, (1-u)v\}$来表示三角形$\{Q_{00}, Q_{01}, Q_{01}\}$的重心坐标。作为替代方案，等式1的插值公式可以直接使用。

图8-3显示了斯坦福兔子模型在OptiX[20]中通过光线追踪渲染的不同版本。我们使用$1000 \times 1000$屏幕分辨率，对于每个像素发射一条主要光线，对于每个相交点，发射九条环境光遮挡(AO)光线。旨在模拟典型光线追踪中的主要光线和次要光线的的分布。通过计算每秒处理的光线总数来测量性能，从而减轻主光线未命中对总体性能的影响。我们将环境遮挡距离设为$\infty$，并让这些光线在命中任何模型后终止。

Blender使用了原始模型的顶点，而即时网格系统尝试优化顶点的位置，并且可以设置顶点数量的目标值。图8-3d和8-3e显示了系统得到的网格。图8-3a和8-3c均使用Phong着色法渲染。

作为对比，Ramsey等人[24]的单精度方法在图8-3b的模型中达到了每秒409M条光线，在图8-3c中达到了每秒406M条光线。对于双精度方法，性能下降到了每秒196M和198M条光线。

这些四边形化系统并不知道我们想要渲染非平面图元。所以这些系统的生产的网格的平整度作为质量衡量标准，输出的四边形有1%是完全平坦的。我们认为这是我们目前四边形网格生成过程的局限性，也是未来利用双线性插值面片的非平面性质的机会。
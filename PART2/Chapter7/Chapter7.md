# 第七章：光线/球体相交检测的精度优化


## 摘要
计算光线/球体相交的传统方法是直接解二次方程。
虽然这种因式分解法在数学上是正确的，但是在使用浮点数进行计算时可能会出现数值不稳定性。
本文给出两种不常见的方程解法，并且展示他们对计算精度的优化效果。


## 7.1 光线/球体相交基础
球体是最容易用来光线追踪的物体之一，因此很多早期的光线追踪生成的图片都以球体作为主体。如图 7-1。
!["图7-1"](Figure7-1.jpeg) <br>
*图7-1：球形分形雪花场景。地面是一个巨大的球体。场景中有四千八百万个球体，其中大多数要小于一个像素[9]*
<br><br>
任意球体都可以用他的中心坐标 G 和半径 r 来定义。对于此球体表面上的任意点P, 有方程：<br>
(P-G)×(P-G)=r<sup>2</sup>.  <br>
在求解球体与光线的相交时，上式中的P应被替换成 R(t) = O + t **d**（见第二章）。令 **f** = O - G, 并简化方程，即可得到：<br>
(**d**•**d**) t<sup>2</sup> + 2(**f**•**d**) t + **f**•**f** - r<sup>2</sup> = at<sup>2</sup> + bt + c = 0 <br>
此二次方程的解是<br>
t<sub>0,1</sub> = (- b ± b<sup>2</sup>-4ac) / (2a) <br>
如果判别式 Δ = b<sup>2</sup>-4ac < 0, 则光线与球体不相交；如果Δ = 0，则光线刚好擦过球体表面 （即两个交点重合）；
如果Δ > 0, 那么两个不同的t值则对应着两个不同的交点。如图7-2。
!["图7-2"](Figure7-2.jpeg) <br>
*图7-2：光线/球体相交检测。三种不同的情况，从上到下分别为，不相交，两个交点，和单个交点（两个重合的交点）*
<br><br>
将t值带入光线方程，即可得到两个交点：P<sub>0,1</sub> = R(t<sub>0,1</sub>) = O + t<sub>0,1</sub>**d**。
在计算出交点（比如P<sub>0</sub>）之后，这一点的单位法线为
**n** = P<sub>0</sub> - G 。


# Importance Sampling of Many Lights on the GPU

## 简介
引入用于光线跟踪的标准化API以及硬件加速，为实时渲染中的物理光照提供了可能性。光源的重要性采样是光线传输模拟中的基本操作之一，适用于直接照明和间接照明。  
本章描述了一种包围盒层次数据结构和相关的采样方法，从而加速局部光源的重要性采样。这项工作基于最近发布的用于渲染中的光采样方法，但将它使用Microsoft DirectX Raytracing来实现实时效果。  
## 18.1 引入
一个现实场景可能会包含数十万个光源。对灯光和它们投射的阴影的精确模拟在图形学中是真实感的最重要影响因素之一。使用光栅阴影贴图的传统实渲染的应用，在实际中被限制于使用手工调整的动态光源。而光线跟踪允许更大的灵活性，因为我们在每个像素点对于不同的光源追踪阴影光线。  
从数学上讲，选择这些样本的最佳方法是，选择光源，其概率与每个光源的贡献成比例。然而，贡献在空间上是变化的，并且这取决于局部的表面特性和光源的可见性。因此，找到一个适用于所有地方的单一全局概率密度函数(PDF)具有挑战性。  
我们在本章中探讨的解决方案是使用在光源上构建的分层加速结构来指导采样[[11][11],[22][22]]。数据结构中的每个节点代表一组光源。使用的想法是从上向下遍历树，在每一层估计每组光源的贡献，并根据在每层的随机决策选择向下遍历的路径。图[18-1][18-1]演示了这些概念。
![](https://i.postimg.cc/qM6YgZ7V/ch18-001.png)
图片18-1. 全部光源都按照层次结构来组织。对于一个给定的着色点$x$，我们从根开始沿层次结构向下前进。在每一层，按照概率来估计每个直接子节点关于$x$的重要性。然后，均匀采样$\xi$来决定树上的路径，并在叶子处找到要采样的光源。最后，更重要的光源有更高的概率被采样到。  

这意味着光源的选择与其贡献近似成正比，但不需要显式计算和储存PDF在每个着色点。该技术的表现最终取决于我们如何准确估计光源的贡献。实际上，一个光源或一组光源的相关性取决于它的:  
- 辐射通量:光源越强，它的贡献就越大。  
- 到着色点的距离:光源越远，它所包围的立体角越小，使得到达着色点的能量就越少。  
- 朝向:光源可能不会在所有方向上发光，也不会均匀地发光。  
- 可见性:全部被遮挡的光源没有贡献。  
- 着色点的BRDF:位于BRDF主峰方向的光源将被反射更多的能量。  

光源重要性采样的关键优点在于，它与光源的类型和数量无关，因此场景可以有比我们能够追踪的阴影光线更多的光源，并且可以无缝支持大纹理的面积光源。因为概率贡献是在运行时计算的，场景可以完全动态并具有复杂的光源设置。随着最近降噪技术的进步，这有望减少渲染的时间，同时允许更大的艺术自由和更真实的结果。  
接下来，我们将更加详细地讨论光源重要性采样,并提供一种在光源上使用包围盒层次结构(BVH)的实时实现方式。该方法使用Microsoft DirectX Raytracing(DXR)API实现，并且源代码是公开的。  
## 18.2 回顾以前的算法
随着在工业生产中，渲染向路径追踪转变[[21][21],[31][31]]，通过追踪向光源上的采样点的阴影光线来解决可见性采样。当一条阴影光线在采样点到光源的路径上没有击中任何物体，采样点被认为是可见的。通过对光源表面很多的采样点的平均，一种不错的光源近似方法被实现。随着采样数量的增多，这种近似收敛于真实。但是，当处理大量光源时，这种全面的采样方法，即使在工业生产的渲染中，也并不是一种可行的策略。  
为了处理这种有大量光源的复杂动态照明场景，大多数技术通常依赖于在灯光上建立某种形式的空间加速结构，然后通过剔除，近似或重要采样灯来加速渲染。  
### 18.2.1  实时光源剔除  
游戏引擎转变为使用大多数基于物理的材质和以物理单位确定的光源[[19][19],[23][23]]。但是，出于性能原因和由于光栅管线的限制，只有一些类似点的光源可以使用阴影映射(shadow map)被实时渲染。每个光源的花费很高，性能与光源个数呈线性关系。对于面光源，非阴影的贡献可以使用线性变换的余弦项来计算[[17][17]]，但是评估可见性的问题仍然存在。  
为了去减少需要考虑的光源数量，通常人为地去限制每个光源的影响区域，例如，通过使用一个近似的二次衰减，使得在光源在某个距离变为零。通过细心摆放和调整光源的参数，影响给定点的光源数量被限制住。  
片源着色(Tiled shading)[[2][2],[28][28]]的工作原理是将这些光源放入屏幕空间中的片源，其中片源的深度约束有效地减少了在对每个片源进行着色时所需要处理的光源数量。现代。现在的变种通过分割深度(2.5D剔除)[[15][15]，聚类着色点或光源[[29][29],[30][30]]，或使用每个片源的光源树[[27][27]]来提高剔除率。  
这些剔除方法的一个缺点是加速结构是在屏幕空间中的。另一个缺点是所需的限制光源范围会引入明显的变暗。在许多昏暗的光源有重大贡献的情况下，例如圣诞树灯或室内办公室照明时，这一点尤为明显。为了解决这个问题，Tokuyoshi和Harada[[40][40]]提出了使用随机光源范围来随机拒绝不重要的光源，而不是安排一个固定的范围。他们还将这个技术应用于在光源上使用球形包围层次结构的路径追踪中，来展示了对这个想法的验证。  
### 18.2.2 多光源的算法  
虚拟点光源(VPLs)[[20][20]]长期以来被用于近似全局照明。这个想法是去追踪从光源发出的光子，并存储VPLs到路径节点上，之后被用来近似间接光照。VPL方法被概念性地近似于对光源的重要性采样方法。光源被聚类到树中节点上，并且在遍历期间计算估计贡献。主要的差异在于，对于重要性采样，估计值被用于计算光源选择概率，而不是直接用来近似光源。  
例如，光源切割(lightcuts)[[44][44],[45][45]]通过遍历每个着色点的树并计算估计贡献的误差界限来使用数百万VPLs加速渲染。当误差足够小时，这个算法选择去使用一组VPLs直接作为光源，避免细分为更细小的组或单个VPLs。我们参考Dachsbacher等人的研究[[12][12]]，对这些和其他多光源技术进行了不错的概述。另请参阅Christensen和Jarosz[[8][8]]对全局照明算法的概述。  
### 18.2.3 光源重要性采样
在早期加速对多光源的光线最终加速中，光源被按照贡献排序，并且只有大于阈值的光源被进行阴影检测(shadow test)[[46][46]]。然后基于其可见度的统计估计值来添加剩余光的贡献。  
Shirley等人[[37][37]]描述了对于不同类型光源的重要性采样。他们将光源按照亮或暗来分类，通过比较他们的估计贡献和一个用户定义的阈值。为了从多个光源中采样，他们使用一个分层细分的八叉树，划分直到明亮的灯光数量足够小。通过评估格子边界上的大量点的贡献来估计八叉树格子的贡献。Zimmerman和Shirley[[47][47]]使用了一种空间均匀细分的方法来代替，并且在格子里包含了对可见性的估计。对于多光源的实时光线追踪，Schmittler等人[[36][36]]限制了光源的影响区域，并且使用k-d树来快速找到影响每个点的光源。Bikker在Arauna引擎中使用一种类似的方法[[5][5],[6][6]]，但是它使用了一个球形节点的BVH去收紧光源的边界。着色使用了Whitted-style的方法来评估所有贡献光源。这些方法受到偏差的影响，因为光的贡献被切断了，但如前面提到的那样，可以通过随机光源范围来缓解这个问题[[40][40]]。  
在Brigade实时光线追踪引擎中，Bikker[[6][6]]使用重新抽样重要性抽样(resampled importance sampling)[[39][39]]。基于位置无关的概率密度函数来选择第一组光源，然后在该组光源中使用BRDF和距离来更精确地估计贡献并选择一个重要的光源。在这种方法中，没有分层数据结构。   
Iray渲染系统[[22][22]]中使用一个分层光源重要性采样方案。Iray只使用三角形，并为每个三角形安排一个辐射通量(功率)值。BVH建立在三角形光源上并且按照概率来遍历，在每个节点处计算每个子树的估计贡献。系统通过将单位球体划分为少量区域并且在每个区域存储一个代表性通量值来对每个节点处的方向信息进行编码。来自BVH节点的估计辐射通量值基于到节点中心的距离来计算。  
Conty Estevez和Kulla[[11][11]]采用类似的方法进行电影渲染。他们使用宽度为4的BVH，其中还包括解析形状光源，并且对光源及其朝向在世界空间中进行聚类，朝向使用边界锥体来确定。在遍历过程中，它们基于一个均匀的随机数按照概率来选择要遍历的分支。这个随机数在每一步被重新调整到单位范围，从而保留了分层属性(在分层样本抽样中使用相同的技术[[9][9]])。为了减少较大的节点估计不良的问题，他们使用一个度量值来在遍历期间自适应地分割这些节点。我们的实时实现方法基于他们的技术，并进行了一些简化。  
## 18.3 基础 (6-11)
本章中，在深入挖掘我们实时实现方法的技术细节之前，我们首次回顾一些基于物理的光照和重要性采样的基础。  
### 18.3.1 光照积分
在物体表面上从点$X$离开，沿着观察方向$\boldsymbol{v}$的辐射度$L_o$，是发光辐射度$L_{e}$和反射辐射度$L_{r}$之和。在[[18][18]]描述的几何光学近似下为：  
$$L_{o}(X,\boldsymbol{v})=L_{e}(X,\boldsymbol{v})+L_{r}(X,\boldsymbol{v})   \ \ \ \ (1)$$   
$$L_{r}(X,\boldsymbol{v})=\int_{\Omega}f(X,\boldsymbol{v},\boldsymbol{l})L_{i}(X,\boldsymbol{l})(\boldsymbol{n}\cdot\boldsymbol{l})d\omega\ \ \ \ (2)$$  
此处的$f$是双向反射函数BRDF，$L_{i}$是烟方向$\boldsymbol{l}$的入射辐射度。接下来，当讨论一个具体的点时，我们将去掉$X$标识。同时，令$L(X\leftarrow Y)$表示从点$Y$朝向点$X$方向发射的辐射度。  
在本章中，我们主要关注$L_{i}$来自放置在场景中潜在的大的局部光源的情况。但是，该算法同时也可以结合其他采样策略，从而用于处理远距离光源（例如太阳和天空）。  
半球上的积分可以重写为光源的整个表面上的积分。立体角和表面积之间的关系如图[18-2][18-2]所示。事实上，光源上点$Y$的一小块$dA$覆盖一个立体角为  
$$d\omega=\frac{|\boldsymbol{n}_{Y}\cdot-\boldsymbol{l}|}{‖X-Y‖^2}dA\ \ \ \ (3)$$  
![](https://i.postimg.cc/x1rnwqMx/ch18-002.png)
图片18-2. 光源上点$Y$的一小块$dA$覆盖微分立体角$d\omega$是它的距离$‖X-Y‖$和角度$cosθ=|\boldsymbol{n}_{Y}\cdot-\boldsymbol{l}|$的函数。  
即，通过距离，光源的法线$\boldsymbol{n}_Y$与发射光方向$-\boldsymbol{l}$之间的点积来平方反比衰减。注意，在我们的实现中，光源可以是单面或双面的光源。对于单面的光源，我们设置当$(\boldsymbol{n}_{Y}\cdot-\boldsymbol{l})\le 0$时，发出的辐射度$L(X\leftarrow Y)=0$。  
我们也需要去知道着色点$X$与光源上的点$Y$的可见性信息，正式表示为  
$$v(X\leftrightarrow Y)=\left\{
\begin{aligned}
1 &\ \ 当X与Y互相可见 \\
0 &\ \ 否则 
\end{aligned}
\right.$$  
在实践中，我们通过在方向$\boldsymbol{l}$上追踪来自$X$的阴影射线来评估$v$，其中射线的最大距离为$t_{max}=‖X-Y‖$。请注意，为了避免由于数值问题导致的自相交，需要使用epsilons来偏移光线原点并略微缩短光线。详见第6章。  
现在，假设在场景中有$m$个光源，在方程[2]中反射的辐射度可以被写作  
$$L_{r}(X,\boldsymbol{v})=\sum_{i=1}^{m}L_{r,i}(X,\boldsymbol{v})$$  
$$L_{r,i}(X,\boldsymbol{v})=\int_{\Omega}f(X,\boldsymbol{v},\boldsymbol{l})L_{i}(X\leftarrow Y)v(X\leftrightarrow Y)\max(\boldsymbol{n}_{Y}\cdot\boldsymbol{l},0)\frac{|\boldsymbol{n}_{Y}\cdot-\boldsymbol{l}|}{‖X-Y‖^2}dA_{i}$$    
也就是说，$L_{r}$是来自每个单独光源$i=\{1,\dots,m\}$的反射光的总和。请注意，我们控制(clamp)$\boldsymbol{n}\cdot\boldsymbol{l}$，因为来自背面到阴影点的光没有贡献。复杂度与光源数量$m$是呈线性关系的，当$m$很大时，这可能变得昂贵。 这引导我们进入下一个主题。  
### 18.3.2 重要性采样  
如第[18.2]节所述，有两种完全不同的方法可以降低公式5的成本。一种方法是限制光源的影响区域，从而减小$m$。另一种方法是采样一小部分光源$n\ll m$。这可以使用一致(consistent)的方式来完成，即，随着$n$的增长它收敛于基本事实(ground truth)。  
##### 18.3.2.1 蒙特卡洛方法
令$Z$为离散随机变量，权值$z\in\{1,\dots,m\}$。$Z$的值为$z$的概率可以被表示为离散型PDF，$p(z)=P(Z=z)$，其中$\sum p(z)=1$。例如，如果所有值等概率，那么$p(z)=\frac{1}{m}$。如果我们对于随机变量$Z$有一个函数$g(Z)$，它的期望为  
$$\mathbb{E}[g(Z)]=\sum_{z\in Z}g(z)p(z)$$  
即，每个可能的结果按其概率加权。现在，如果我们从$Z$中取$n$个随机样本$\{z_1,\dots,z_n\}$，我们得到了对于$\mathbb{E}[g(Z)]$的$n$-样本蒙特卡洛估计值$\widetilde{g}_n(z)$如下： 
$$\widetilde{g}_n(z)=\frac{1}{n}\sum_{j=1}^{n}g(z_j)$$  
换句话说，可以通过取函数随机样本的均值来估计期望值。我们也可以说蒙特卡罗估计$\widetilde{g}_n(Z)$，是$n$个独立且相同分布的随机变量$\{Z_1,\dots,Z_n\}$的函数值的平均值。很容易证明$\mathbb{E}[\widetilde{g}_n(Z)]=\mathbb{E}[g(Z)]$，即，这个估计给了我们正确的值。  
因为我们取随机样本，估计值$\widetilde{g}_n(Z)$是有方差的。如我们在第15章中讨论的，方差的降低与$n$呈线性关系：  
$$\text{Var}[\widetilde{g}_n(Z)]=\frac{1}{n}\text{Var}[g(Z)]$$  
这些性质表明，蒙特卡洛估计是一致的。在极限情况下，当我们有无限多个样本时，方差为零，并且它已收敛到正确的期望值。  
为了使它有用，我们可以发现几乎所有问题都可以转化为求期望。所以我们有一种基于函数的随机样本估计解的一致方法。  
##### 18.3.2.2 光源选择重要性采样
在我们的例子中，我们感兴趣的是评估从所有光源反射的光的总和(公式[5]())。该总和可以表示为期望值(参见等式[7]())，如下所示：  
$$L_{r}(X,\boldsymbol{v}=\sum_{i=1}^{m}L_{r,i}(X,\boldsymbol{v})=\sum_{i=1}^{m}\frac{L_{r,i}(X,\boldsymbol{v})}{P(Z=i)}P(Z=i)=\mathbb{E}[\frac{L_{r,Z}(X,\boldsymbol{v})}{p(Z)}]$$  
接下来的方程[8]()，对于从所有光源反射的光的蒙特卡洛估计$\widetilde{L}_{r}$为  
$$\widetilde{L}_{r}(X,\boldsymbol{v})=\frac{1}{n}\sum_{j=1}^{n}\frac{L_{r,z_j}(X,\boldsymbol{v})}{p(z_j)}$$  
也就是说，我们将随机选择的一组灯$\{z_1,\dots,z_n\}$的贡献除以选择每个灯的概率。这个估计是一致的，与我们采样的样本数量无关。但是，我们采的样本越多，估计量的方差就越小。  
注意到目前为止没有对随机变量$Z$的分布做出任何假设。唯一的要求是对于$L_{r,z}>0$的所有光源的$p(z)>0$，否则我们会冒险忽略某些光源的贡献。可以证明，当$p(z)\propto L_{r,z}(X,v)$[[32](),[38]()]时，方差最小。虽然我们不会在这里详述，但是当概率密度函数与我们正在采样的函数完全成比例时，蒙特卡罗估计中的求和变为为常数项的求和。在这种情况下，估计的方差为零。  
实际上，这是不可能实现的，因为对于给定的着色点，$L_{r,z}$是未知的，但我们应该以尽可能接近它们对着色点的相对贡献的概率来选择光源。在第[18.4]()节中，我们将研究如何计算$p(z)$。  
##### 18.3.2.3 光源采样
为了使用公式[11]()估计反射辐射，我们还需要对于随机选择的一组光估计积分$L_{r,z_j}(X,\boldsymbol{v})$。方程[6]()中的表达式是光源表面上的积分，其中涉及BRDF项和可见性项。在图形学中，解析地计算值是不切实际的。因此，我们再次使用蒙特卡洛求积分。  
在光源表面均匀采样$s$个样本$\{Y_1,\dots,Y_s\}$。对于三角形网格的光源，每个光源都是一个三角形，这意味着我们使用标准技术在三角形上均匀地拾取点[32]()(参见第[16]()章)。三角形$i$上的样本的概率密度函数为$p(Y)=\frac{1}{A_i}$，其中$A_i$是第$i$个三角形的面积。然后使用蒙特卡罗估计来评估光源上的积分  
$$\widetilde{L}_{r,i}(X,\boldsymbol{v})=\frac{A_i}{s}\sum_{k=1}^{s}f(X,\boldsymbol{v},\boldsymbol{l}_{k})L_{i}(X\leftarrow Y_{k})v(X\leftrightarrow Y_k)\max{(\boldsymbol{n}\cdot\boldsymbol{l}_{k},0)}\frac{|\boldsymbol{n}_{Y_k}\cdot -\boldsymbol{l}_{k}|}{‖X-Y_{k}‖^2}$$  
在当前实现中，$s=1$因为对于$n$个采样的光源我们只追踪一条阴影光线，并且$\boldsymbol{n}_{Y_k}=\boldsymbol{n}_i$，因为我们在估计其发射辐射度时使用光源的几何法线。出于性能原因，默认情况下禁用平滑法线和法线贴图，因为它们通常对光分布的影响可以忽略不计。  
#### 18.3.3 对光源的光线追踪
在实时应用中，常见的渲染优化是将几何表示与实际的发光形状分开。例如，灯泡可以使用点光源或小的解析球形光源表示，而可见光灯泡则绘制为更复杂的三角形网格。  
在这种情况下，重要的是光源的几何发射属性与实际光源的强度是否匹配。否则，在直接观察的光源的亮度与其投射到场景中的光强之间会存在感知差异。注意，光源通常以光度(photometric)单位的光通量(luminous flux)(流明)来指定，而区域光的发射强度以亮度($cd/m^2$)给出。因此，从光通量到亮度的精确转换需要考虑光的几何形状的表面积。在渲染之前，这些光度单位最终被转换为我们使用的辐射量（通量和辐射度）。  
另一个考虑因素是当追踪到一个光源的阴影光线时，我们不希望无意中击中代表光源的网格并将光源记为被遮挡。因此，几何表示必须对阴影射线不可见，但对其他射线可见。Microsoft DirectX Raytracing API允许通过加速结构上的InstanceMask属性和TraceRay的InstanceInclusionMask参数来控制此行为。  
对于多重重要性采样(MIS)[[41]()]，这是一种重要的方差减少技术，我们必须能够在使用由其他采样策略生成的样本的情况下评估光源采样概率。例如，如果我们使用在BRDF重要性采样后击中光源的策略，那么我们计算概率时要考虑在光源上重要性采样。基于该概率以及BRDF采样概率，可以使用例如幂次启发式的方法[[41]()]来计算样本的新权重以减小总体方差。  
MIS的一个实际考虑因素是，如果光源时由解析形状表示，我们不能使用硬件加速三角测试来搜索给定方向的光源。另一种方法是使用自定义相交着色器来计算光线和光源形状之间的交点。这在我们的示例代码中尚未实现。而我们总是使用网格本身作为光源，即每个发光三角形被视为光源。  
## 18.4 算法 (11-17)
## 18.5 结果 (17-25)
## 18.6 结论 (26-26)

[18.2]:18.2
[18-1]:18-1
[18-2]:18-2
[1]:1  
[2]:2  
[3]:3  
[4]:4  
[5]:5  
[6]:6  
[7]:7  
[8]:8  
[9]:9  
[10]:10  
[11]:11  
[12]:12  
[13]:13  
[14]:14  
[15]:15  
[16]:16  
[17]:17  
[18]:18  
[19]:19  
[20]:20  
[21]:21  
[22]:22  
[23]:23  
[24]:24  
[25]:25  
[26]:26  
[27]:27  
[28]:28  
[29]:29  
[30]:30  
[31]:31  
[32]:32  
[33]:33  
[34]:34  
[35]:35  
[36]:36  
[37]:37  
[38]:38  
[39]:39  
[40]:40  
[41]:41  
[42]:42  
[43]:43  
[44]:44  
[45]:45  
[46]:46  
[47]:47  
[48]:48  
